<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英语打卡（3个孩子）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --text:#e8eefc; --muted:#a7b3d1;
      --accent:#5aa7ff; --good:#35d07f; --warn:#ffcc66; --border:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:linear-gradient(180deg,#070b14 0%, #0b1220 45%, #070b14 100%);
      color:var(--text);
    }
    .wrap{max-width:760px;margin:0 auto;padding:18px;}
    .top{
      padding:14px 16px;border:1px solid var(--border);border-radius:14px;
      background:rgba(17,27,46,.78);backdrop-filter: blur(8px);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;
    }
    h1{font-size:18px;margin:0 0 6px 0}
    .meta{font-size:12px;color:var(--muted);line-height:1.5}
    .card{
      margin-top:12px;
      border:1px solid var(--border);border-radius:14px;background:rgba(17,27,46,.78);
      padding:14px 16px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select, textarea, input{
      width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border);
      color:var(--text);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    button{
      border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;background:rgba(255,255,255,.05);color:var(--text);
      cursor:pointer;font-weight:700;
    }
    button.primary{background:linear-gradient(135deg, rgba(90,167,255,.35), rgba(90,167,255,.10)); border-color:rgba(90,167,255,.45)}
    button.good{background:linear-gradient(135deg, rgba(53,208,127,.28), rgba(53,208,127,.08)); border-color:rgba(53,208,127,.40)}
    button.warn{background:linear-gradient(135deg, rgba(255,204,102,.22), rgba(255,204,102,.06)); border-color:rgba(255,204,102,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);
    }
    .big{font-size:18px;font-weight:900}
    .small{font-size:12px;color:var(--muted);line-height:1.5}
    .tag{
      font-size:12px;font-weight:800;border-radius:999px;padding:7px 10px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .tag.ok{border-color:rgba(53,208,127,.55); color:#bff5d7}
    .tag.no{border-color:rgba(255,204,102,.55); color:#ffe4a8}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 720px){ .grid{grid-template-columns:1.05fr .95fr;} }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{font-size:12px;padding:8px 6px;border-bottom:1px solid var(--border);text-align:left;color:var(--muted)}
    th{color:#cfe0ff;font-weight:800}
    td strong{color:var(--text)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,27,46,.92);border:1px solid var(--border);color:var(--text);
      padding:10px 12px;border-radius:12px;font-size:12px;max-width:92vw;display:none;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .hint{font-size:12px;color:var(--muted);line-height:1.6;margin-top:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>英语打卡（3个孩子）</h1>
      <div class="meta">
        每天每人一次，手动填写英语内容（支持语音转文字）。<br/>
        积分：每日 +10；连续第3天 +5，第7天 +10，第14天 +20（当天额外奖励）。
      </div>
    </div>
    <div class="meta mono" style="text-align:right">
      今日：<span id="todayPill">-</span><br/>
      环境：<span id="envPill">-</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <label>选择孩子</label>
      <select id="kidSelect"></select>

      <div class="status" style="margin-top:10px;">
        <div>
          <div class="big" id="kidSummary">-</div>
          <div class="small" id="kidSub">-</div>
        </div>
        <div class="tag no" id="todayTag">未打卡</div>
      </div>

      <div style="margin-top:10px;">
        <label>今日英语打卡内容（手动填写 / 语音输入）</label>
        <textarea id="content" placeholder="示例：Today I read a story and learned 5 new words..."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnVoice" class="primary" type="button">语音输入（英文）</button>
        <button id="btnStopVoice" type="button" disabled>停止</button>
      </div>
      <div class="hint" id="voiceHint">
        提示：若语音按钮不可用，请用手机键盘自带“听写/麦克风”完成语音转文字。
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="good" id="btnCheckin">打卡并加分</button>
        <button class="primary" id="btnViewMine">查看我的记录</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="warn" id="btnExport">导出CSV（本机）</button>
        <button id="btnResetAll">重置全部数据（本机）</button>
      </div>

      <div class="hint">
        说明：数据保存在当前设备浏览器里；如果换手机/电脑，数据不会自动同步。
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <div style="font-weight:800;color:#dbe6ff">排行榜</div>
          <div class="meta">按总积分排序（同分按连续天数）。</div>
        </div>
        <div class="meta mono" style="text-align:right">v0.3</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:36%">孩子</th>
            <th style="width:18%">积分</th>
            <th style="width:18%">连续</th>
            <th style="width:28%">今日</th>
          </tr>
        </thead>
        <tbody id="rankBody">
          <tr><td colspan="4">暂无数据</td></tr>
        </tbody>
      </table>

      <div class="hint">
        小提示：连续打卡更“值钱”，更容易长期坚持。
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ===== 可配置：三个孩子的名字（你直接改这里即可） =====
  const KIDS = ["孩子A", "孩子B", "孩子C"]; // 例如：["乐乐","笑笑","豆豆"]

  // ===== 积分规则（简单可解释）=====
  const BASE_POINTS = 10;           // 每日打卡基础分
  const STREAK_BONUS = {            // 连续天数触发额外奖励（当天额外加分）
    3: 5,
    7: 10,
    14: 20
  };

  // ===== Storage =====
  const DB_KEY = "kids_english_checkin_v03";
  const $ = (id) => document.getElementById(id);
  const toast = (msg) => {
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => el.style.display = "none", 2400);
  };

  const localDateStr = (d = new Date()) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  };
  const nowTimeStr = (d = new Date()) => {
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    const ss = String(d.getSeconds()).padStart(2, "0");
    return `${hh}:${mm}:${ss}`;
  };

  const loadDB = () => {
    try { return JSON.parse(localStorage.getItem(DB_KEY) || "{}"); }
    catch { return {}; }
  };
  const saveDB = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));
  const ensureDB = (db) => {
    if (!db.kids) db.kids = {};
    // per kid: { points: number, streak: number, lastDate: "YYYY-MM-DD"|null, logs: [ {date,time,content,pointsAwarded,bonusAwarded} ] }
    for (const name of KIDS) {
      if (!db.kids[name]) db.kids[name] = { points: 0, streak: 0, lastDate: null, logs: [] };
      if (!Array.isArray(db.kids[name].logs)) db.kids[name].logs = [];
      if (typeof db.kids[name].points !== "number") db.kids[name].points = 0;
      if (typeof db.kids[name].streak !== "number") db.kids[name].streak = 0;
    }
    return db;
  };

  const daysBetween = (d1, d2) => {
    // d1,d2: YYYY-MM-DD
    const a = new Date(d1 + "T00:00:00");
    const b = new Date(d2 + "T00:00:00");
    return Math.round((b - a) / (24 * 3600 * 1000));
  };

  const hasCheckedToday = (kid, today) => kid.logs.some(x => x.date === today);

  const calcAward = (kid, today) => {
    let newStreak = kid.streak || 0;
    if (!kid.lastDate) {
      newStreak = 1;
    } else {
      const diff = daysBetween(kid.lastDate, today);
      if (diff === 1) newStreak = newStreak + 1;
      else if (diff === 0) return { ok: false, reason: "已打卡" };
      else newStreak = 1;
    }
    const bonus = STREAK_BONUS[newStreak] || 0;
    const total = BASE_POINTS + bonus;
    return { ok: true, newStreak, bonus, total };
  };

  const escapeHtml = (s) =>
    String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  const render = () => {
    const today = localDateStr();
    $("todayPill").textContent = today;
    $("envPill").textContent = /MicroMessenger/i.test(navigator.userAgent) ? "WeChat" : "Browser";

    const selected = $("kidSelect").value;
    const db = ensureDB(loadDB());
    const kid = db.kids[selected];

    const checked = hasCheckedToday(kid, today);
    $("kidSummary").textContent = `${selected}：${kid.points} 分`;
    $("kidSub").textContent = `连续 ${kid.streak} 天｜最后打卡：${kid.lastDate || "-"}`;

    if (checked) {
      $("todayTag").textContent = "今日已打卡";
      $("todayTag").className = "tag ok";
      $("btnCheckin").disabled = true;
    } else {
      $("todayTag").textContent = "今日未打卡";
      $("todayTag").className = "tag no";
      $("btnCheckin").disabled = false;
    }

    const rows = KIDS.map(name => {
      const k = db.kids[name];
      const checkedToday = hasCheckedToday(k, today);
      return { name, points: k.points, streak: k.streak, today: checkedToday ? "已打卡" : "未打卡" };
    }).sort((a,b) => (b.points - a.points) || (b.streak - a.streak) || a.name.localeCompare(b.name));

    $("rankBody").innerHTML = rows.map(r => `
      <tr>
        <td><strong>${escapeHtml(r.name)}</strong></td>
        <td class="mono">${r.points}</td>
        <td class="mono">${r.streak}</td>
        <td>${r.today}</td>
      </tr>
    `).join("");
  };

  // init select
  const sel = $("kidSelect");
  sel.innerHTML = KIDS.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");

  // actions
  sel.addEventListener("change", () => { $("content").value = ""; render(); });

  $("btnCheckin").addEventListener("click", () => {
    const today = localDateStr();
    const db = ensureDB(loadDB());
    const name = sel.value;
    const kid = db.kids[name];

    if (hasCheckedToday(kid, today)) {
      toast("今天已经打过卡了");
      render();
      return;
    }

    const text = $("content").value.trim();
    if (!text) return toast("请先填写英语打卡内容");

    const award = calcAward(kid, today);
    if (!award.ok) return toast(award.reason || "无法打卡");

    kid.points += award.total;
    kid.streak = award.newStreak;
    kid.lastDate = today;
    kid.logs.push({
      date: today,
      time: nowTimeStr(),
      content: text,
      pointsAwarded: BASE_POINTS,
      bonusAwarded: award.bonus
    });

    saveDB(db);
    $("content").value = "";
    toast(`打卡成功：+${BASE_POINTS} 分${award.bonus ? `，连续奖励 +${award.bonus} 分` : ""}`);
    render();
  });

  $("btnViewMine").addEventListener("click", () => {
    const db = ensureDB(loadDB());
    const name = sel.value;
    const logs = db.kids[name].logs
      .slice()
      .sort((a,b) => (b.date + b.time).localeCompare(a.date + a.time))
      .slice(0, 30);

    if (!logs.length) return toast("暂无记录");

    const lines = logs.map(x =>
      `${x.date} ${x.time}  +${x.pointsAwarded}${x.bonusAwarded ? `(+${x.bonusAwarded})` : ""}\n- ${x.content}`
    ).join("\n\n");

    alert(`${name} 最近记录（最多30条）：\n\n${lines}`);
  });

  $("btnExport").addEventListener("click", () => {
    const db = ensureDB(loadDB());
    const rows = [["kid","date","time","base_points","bonus_points","content"]];
    for (const kidName of KIDS) {
      for (const x of db.kids[kidName].logs) {
        rows.push([
          kidName, x.date, x.time, x.pointsAwarded, x.bonusAwarded,
          (x.content || "").replace(/\n/g, " ")
        ]);
      }
    }
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `kids_english_checkin_${localDateStr()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("已导出CSV（本机）");
  });

  $("btnResetAll").addEventListener("click", () => {
    if (!confirm("确定重置本机所有孩子的数据？此操作不可恢复。")) return;
    localStorage.removeItem(DB_KEY);
    toast("已重置");
    render();
  });

  // ===== 语音转文字（Web Speech API）=====
  (() => {
    const btnVoice = $("btnVoice");
    const btnStop = $("btnStopVoice");
    const hint = $("voiceHint");
    const textarea = $("content");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      btnVoice.disabled = true;
      if (hint) hint.textContent = "当前浏览器不支持网页语音识别。请使用手机键盘自带“听写/麦克风”。";
      return;
    }

    const rec = new SpeechRecognition();
    rec.lang = "en-US";           // 英语识别
    rec.interimResults = true;    // 临时结果
    rec.continuous = false;       // 一次一段（更稳）

    let finalText = "";
    const setUI = (on) => {
      btnVoice.disabled = on;
      btnStop.disabled = !on;
      if (hint) hint.textContent = on
        ? "正在识别… 请说英语。识别结束后会自动填入文本框。"
        : "提示：若语音按钮不可用，请用手机键盘自带“听写/麦克风”完成语音转文字。";
    };

    rec.onresult = (e) => {
      let interim = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) finalText += t + " ";
        else interim += t;
      }
      textarea.value = (textarea.value.replace(/\s+$/,"") + " " + finalText + interim).trim();
    };

    rec.onerror = (e) => {
      setUI(false);
      if (hint) hint.textContent = `语音识别失败：${e.error || "unknown"}。可改用键盘听写。`;
    };

    rec.onend = () => {
      setUI(false);
      finalText = "";
    };

    btnVoice.addEventListener("click", () => {
      try {
        setUI(true);
        finalText = "";
        rec.start();
      } catch {
        setUI(false);
        if (hint) hint.textContent = "无法启动语音识别。请改用键盘听写。";
      }
    });

    btnStop.addEventListener("click", () => {
      try { rec.stop(); } catch {}
    });
  })();

  // first render
  render();
})();
</script>
</body>
</html>
